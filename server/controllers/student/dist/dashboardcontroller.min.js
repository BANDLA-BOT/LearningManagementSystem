"use strict";var Student=require("../../models/users/studentModel.js"),courseModel=require("../../models/course/courseModel.js"),getProfile=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user,console.log(n),e.prev=2,e.next=5,regeneratorRuntime.awrap(Student.findById({_id:n.id}).select("-password"));case 5:return s=e.sent,e.next=8,regeneratorRuntime.awrap(courseModel.find().limit(61));case 8:if(a=e.sent,s){e.next=11;break}return e.abrupt("return",t.json({message:"No student found "}));case 11:if(a){e.next=13;break}return e.abrupt("return",t.json({message:"No courses available currently"}));case 13:t.json({message:"Students Profile",Profile:s,courses:a}),console.log(s),e.next=19;break;case 17:e.prev=17,e.t0=e.catch(2);case 19:case"end":return e.stop()}},null,null,[[2,17]])},editProfile=function(r,t){var n,s,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body,s=n.email,a=n.firstname,o=n.lastname,u=r.user.id,console.log(u),e.next=6,regeneratorRuntime.awrap(Student.updateOne({_id:u},{$set:{firstname:a,lastname:o,email:s}}));case 6:e.sent,t.status(200).json({message:"Profile updated successfuly"}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",Error:e.t0.message});case 13:case"end":return e.stop()}},null,null,[[0,10]])},enrollCourse=function(r,t){var n,s,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.params.courseId,s=r.user,e.next=4,regeneratorRuntime.awrap(courseModel.findById({_id:n}));case 4:return a=e.sent,e.next=7,regeneratorRuntime.awrap(Student.findById({_id:s.id}));case 7:if(o=e.sent,e.prev=8,o){e.next=11;break}return e.abrupt("return",t.status(400).json({message:"Student not found"}));case 11:if(a){e.next=13;break}return e.abrupt("return",t.status(400).json({message:"Course not found"}));case 13:return o.enrolled.push({coursesAvailable:a._id,isComplete:!1}),e.next=16,regeneratorRuntime.awrap(o.save());case 16:t.status(200).json({Message:"Course enrolled successfuly",Student:o}),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(8),t.status(500).json({message:"Internal server error",Error:e.t0.message});case 22:case"end":return e.stop()}},null,null,[[8,19]])},deleteEnroll=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.user,s=r.params.courseId,e.next=5,regeneratorRuntime.awrap(Student.updateOne({_id:n.id},{$pull:{enrolled:{_id:s}}}));case 5:0<(a=e.sent).nModified&&t.status(200).send({message:"Enrolls Updated"}),t.json({EnrollUpdated:a}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),t.status(500).send({message:"Server error",error:e.t0});case 13:case"end":return e.stop()}},null,null,[[0,10]])},topRanks=function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Student.aggregate([{$match:{"enrolled.isComplete":!0}},{$addFields:{Count:{$size:{$filter:{input:"$enrolled",as:"enrolled",cond:{$eq:["$$enrolled.isComplete",!0]}}}}}},{$sort:{_id:-1}},{$project:{firstname:1,lastname:1,Count:1}}]));case 3:t=e.sent,r.status(200).json({rankings:t}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(500).json({message:"Internal server error"});case 10:case"end":return e.stop()}},null,null,[[0,7]])},markVideoAsComplete=function(r,t){var n,s,a,o,u,c,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params,s=n.courseId,a=n.videoArrId,o=n.videoId,e.next=4,regeneratorRuntime.awrap(courseModel.findById(s));case 4:if(u=e.sent){e.next=7;break}return e.abrupt("return",t.status(404).json({message:"Course not found"}));case 7:return c=u.section.id(a),(l=c.videos.id(o)).completed=!0,e.next=12,regeneratorRuntime.awrap(u.save());case 12:if(l.completed)return e.abrupt("return",t.json({message:"You have completed the video, move to next"}));e.next=14;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",Error:e.t0.message});case 19:case"end":return e.stop()}},null,null,[[0,16]])},markAsComplete=function(r,t){var n,s,a,o,u,c,l,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.params.courseId,s=r.user,e.next=5,regeneratorRuntime.awrap(courseModel.findById(n));case 5:a=e.sent,o=a.section,u=o[0].videos,l=c=0;case 10:if(!(l<=u.length)){e.next=25;break}if(!u[l].completed){e.next=21;break}if(c++,console.log(u[l]),u.length===c)return e.next=17,regeneratorRuntime.awrap(Student.findOneAndUpdate({_id:s.id,"enrolled.coursesAvailable":n},{$set:{"enrolled.$.isComplete":!0},$addToSet:{completedCourses:{courses:n}}},{new:!0}));e.next=19;break;case 17:return i=e.sent,e.abrupt("return",t.json({message:"Successfully completed Course",Data:i}));case 19:e.next=22;break;case 21:return e.abrupt("return",t.json({message:"You have to complete all the videos"}));case 22:l++,e.next=10;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(0),t.json({message:e.t0.message});case 30:case"end":return e.stop()}},null,null,[[0,27]])},completedCourses=function(r,t){var n,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.user,e.next=4,regeneratorRuntime.awrap(Student.findById(n.id));case 4:s=e.sent,t.json(s.completedCourses),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",error:e.t0.message});case 11:case"end":return e.stop()}},null,null,[[0,8]])},progressController=function(r,t){var n,s,a,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.user.id,e.next=4,regeneratorRuntime.awrap(Student.findById(n));case 4:if(s=e.sent){e.next=7;break}return e.abrupt("return",t.status(404).json({message:"Student not found"}));case 7:a=s.enrolled.length,o=s.enrolled.filter(function(e){return e.isComplete}).length,u={totalCourses:a,completedCourses:o,coursesPercentage:o/a*100},t.status(200).json({message:"Progress report",Progress:u}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),t.json({message:e.t0.message});case 17:case"end":return e.stop()}},null,null,[[0,14]])},courseProgress=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.user.id,e.next=4,regeneratorRuntime.awrap(Student.findById(n).populate("enrolled"));case 4:if(s=e.sent){e.next=7;break}return e.abrupt("return",t.status(404).json({message:"Student not found"}));case 7:return e.next=9,regeneratorRuntime.awrap(Promise.all(s.enrolled.map(function(r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(courseModel.aggregate([{$match:{_id:r.coursesAvailable}},{$unwind:"$section"},{$unwind:"$section.videos"},{$group:{_id:null,totalVideos:{$sum:1},completedVideos:{$sum:{$cond:["$section.videos.completed",1,0]}}}},{$project:{_id:0,totalVideos:1,completedVideos:1,completedPercentage:{$cond:[{$eq:["$totalVideos",0]},0,{$multiply:[{$divide:["$completedVideos","$totalVideos"]},100]}]}}}]));case 2:return t=e.sent,e.abrupt("return",{course:r,progress:t[0]});case 4:case"end":return e.stop()}})})));case 9:a=e.sent,t.json(a),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",error:e.t0.message});case 16:case"end":return e.stop()}},null,null,[[0,13]])},filter=function(r,t){var n,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.query.f,console.log(n),"paid"===n.toLowerCase())return e.next=6,regeneratorRuntime.awrap(courseModel.find().where("price").gt(0));e.next=10;break;case 6:return s=e.sent,e.abrupt("return",t.status(200).json({message:"Paid courses",paidCourses:s}));case 10:if("free"===n.toLowerCase())return e.next=13,regeneratorRuntime.awrap(courseModel.find().where("price").eq(0));e.next=15;break;case 13:return a=e.sent,e.abrupt("return",t.status(200).json({message:"free courses",freeCourses:a}));case 15:t.json({message:"No courses available based on Query"}),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",Error:e.t0.message});case 21:case"end":return e.stop()}},null,null,[[0,18]])},sorting=function(r,t){var n,s,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"asc"===(n=r.query.sort).toLowerCase())return e.next=5,regeneratorRuntime.awrap(courseModel.find().sort({title:1}));e.next=9;break;case 5:return s=e.sent,e.abrupt("return",t.json({message:"Ascending order",course:s}));case 9:if("desc"===n.toLowerCase())return e.next=12,regeneratorRuntime.awrap(courseModel.find().sort({title:-1}));e.next=16;break;case 12:return a=e.sent,e.abrupt("return",t.json({message:"Descending order",course:a}));case 16:if("rating"===n.toLowerCase())return e.next=19,regeneratorRuntime.awrap(courseModel.find().sort({rating:-1}));e.next=21;break;case 19:return o=e.sent,e.abrupt("return",t.json({message:"Rating order",course:o}));case 21:t.json({message:"No Sorting chosen"}),e.next=27;break;case 24:e.prev=24,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",Error:e.t0.message});case 27:case"end":return e.stop()}},null,null,[[0,24]])};module.exports={getProfile:getProfile,enrollCourse:enrollCourse,deleteEnroll:deleteEnroll,topRanks:topRanks,markAsComplete:markAsComplete,completedCourses:completedCourses,progressController:progressController,courseProgress:courseProgress,filter:filter,sorting:sorting,markVideoAsComplete:markVideoAsComplete,editProfile:editProfile};
//# sourceMappingURL=dashboardcontroller.min.js.map
