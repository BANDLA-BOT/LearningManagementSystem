"use strict";var courseModel=require("../../models/course/courseModel.js"),Instructor=require("../../models/users/instructorModel.js"),student=require("../../models/users/studentModel.js"),cloudinary=require("cloudinary").v2,nodemailer=require("nodemailer"),multer=require("multer"),adminModel=require("../../models/users/adminModel.js"),studentModel=require("../../models/users/studentModel.js");cloudinary.config({cloud_name:"diqptwlqn",api_key:process.env.API_KEY,api_secret:process.env.API_SECRET});var dashboardController=function(e,r){var t,s,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(student.find());case 3:return t=e.sent,e.next=6,regeneratorRuntime.awrap(courseModel.find());case 6:return s=e.sent,e.next=9,regeneratorRuntime.awrap(Instructor.find());case 9:if(n=e.sent,t&&s&&n){e.next=12;break}return e.abrupt("return",r.status(404).json({message:"Error while fetching Data"}));case 12:r.status(200).json({message:"Fetched Data",courses:s,students:t,Instructor:n}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),r.status(500).json({message:"Internal server error",error:e.t0.message});case 18:case"end":return e.stop()}},null,null,[[0,15]])},searchController=function(r,t){var s,n,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.query.q,e.next=4,regeneratorRuntime.awrap(courseModel.find({$or:[{title:{$regex:s,$options:"i"}}]}));case 4:return n=e.sent,e.next=7,regeneratorRuntime.awrap(Instructor.find({$or:[{firstname:{$regex:s,$options:"i"}},{lastname:{$regex:s,$options:"i"}},{email:{$regex:s,$options:"i"}}]}));case 7:return a=e.sent,e.next=10,regeneratorRuntime.awrap(student.find({$or:[{firstname:{$regex:s,$options:"i"}},{lastname:{$regex:s,$options:"i"}},{email:{$regex:s,$options:"i"}}]}));case 10:if(o=e.sent,n&&o&&a){e.next=13;break}return e.abrupt("return",t.status(404).json({message:"Not found"}));case 13:t.status(200).json({message:"Results fetched",Students:o,courses:n,InstructorData:a}),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),t.status(500).json({message:"Internal server error",error:e.t0.message});case 19:case"end":return e.stop()}},null,null,[[0,16]])},createCourse=function(r,t){var s,n,a,o,u,c,i,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.body,n=s.title,a=s.price,o=s.description,u=r.params.instructorId,e.next=5,regeneratorRuntime.awrap(Instructor.findById(u));case 5:return c=e.sent,e.next=8,regeneratorRuntime.awrap(courseModel.create({title:n,price:a,description:o,instructor:u}));case 8:e.sent,i=nodemailer.createTransport({service:"gmail",auth:{user:process.env.EMAIL_USER,pass:process.env.EMAIL_PASS},secure:!0}),l={from:process.env.EMAIL_USER,to:c.email,subject:"Task Added",html:"You have assigned to a task\n        <b><p>Coursename:".concat(n,"</p></b>\n        <b><p>Price:").concat(a,"</p></b>\n        <b><p>Description:").concat(o,"</p></b>\n      ")},i.sendMail(l,function(e,r){if(e)return t.json({Message:"Error while sending email",error:e.message});t.json({Message:"Email sent successfully ",Status:"Task assigned succesfully to the ".concat(c.email)})}),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),t.json(e.t0.message);case 17:case"end":return e.stop()}},null,null,[[0,14]])},uploadVideos=function(r,s){var t,n,a,o,u,c;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.params.courseId,n=r.body,a=n.title,o=n.videoTitle,e.next=5,regeneratorRuntime.awrap(courseModel.findById(t));case 5:if(u=e.sent,c=u.section,r.file||r.file.buffer){e.next=9;break}return e.abrupt("return",s.status(400).json({error:"No file provided in the request"}));case 9:cloudinary.uploader.upload_stream({resource_type:"video"},function(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(r)return console.error("Error uploading to Cloudinary:",r),e.abrupt("return",s.status(500).json({error:"Error uploading to Cloudinary"}));e.next=3;break;case 3:return c.push({title:a,videos:[{title:o,url:t.secure_url}]}),e.next=6,regeneratorRuntime.awrap(u.save());case 6:s.status(201).json({message:"Video uploaded successfully",section:u.section});case 7:case"end":return e.stop()}})}).end(r.file.buffer),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("Error uploading video:",e.t0),s.status(500).json({error:"Error uploading video"});case 16:case"end":return e.stop()}},null,null,[[0,12]])},resourceController=function(r,t){var s,n,a,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.courseId,n=r.body.title,r.user,a="".concat(r.file.destination,"/").concat(r.file.filename),e.next=7,regeneratorRuntime.awrap(courseModel.findById(s).populate("resources"));case 7:return(o=e.sent).resources.push({title:n,url:a}),e.next=11,regeneratorRuntime.awrap(o.save());case 11:t.json(o),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(0),t.json(e.t0.message);case 17:case"end":return e.stop()}},null,null,[[0,14]])},acceptCourseRequest=function(r,t){var s,n,a,o,u,c,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.requestId,n=r.body.studentId,e.next=5,regeneratorRuntime.awrap(adminModel.findOne().populate("courseRequests"));case 5:return a=e.sent,e.next=8,regeneratorRuntime.awrap(student.findById({_id:n}).populate("enrolled"));case 8:if(o=e.sent,u=o.enrolled,o){e.next=12;break}return e.abrupt("return",t.status(404).json({Message:"No student found with this ID"}));case 12:if(c=a.courseRequests,(i=c.id(s)).paid){e.next=16;break}return e.abrupt("return",t.status(400).json({Message:"User did not Paid for the course"}));case 16:return i.accept=!0,u.push({coursesAvailable:i.courseId}),e.next=20,regeneratorRuntime.awrap(o.save());case 20:return e.next=22,regeneratorRuntime.awrap(a.save());case 22:t.status(200).json({Message:"Course confirmed"}),e.next=28;break;case 25:e.prev=25,e.t0=e.catch(0),t.status(500).json({Message:"Internal server error",error:e.t0.message});case 28:case"end":return e.stop()}},null,null,[[0,25]])};module.exports={dashboardController:dashboardController,searchController:searchController,createCourse:createCourse,uploadVideos:uploadVideos,resourceController:resourceController,acceptCourseRequest:acceptCourseRequest};
//# sourceMappingURL=dashboardController.min.js.map
